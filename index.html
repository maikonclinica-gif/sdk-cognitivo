<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SDK Cognitivo</title>

  <style>
    :root{
      --bg: #eaf5ef;       /* verde clarinho do fundo */
      --card: #ffffff;
      --border: #cfd8d3;
      --bubble-user: #d9ecff;  /* azul claro */
      --bubble-bot: #efefef;   /* cinza claro */
      --text: #111;
      --muted: #6b7280;
    }

    *{ box-sizing: border-box; }

    body{
      margin: 0;
      font-family: Arial, Helvetica, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: 720px;
      margin: 0 auto;
      padding: 14px 14px 18px;
    }

    /* Header */
    .topbar{
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 10px;
    }

    .title{
      font-size: 36px;
      font-weight: 800;
      letter-spacing: -0.5px;
      margin: 0;
      line-height: 1;
    }

    .right{
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: nowrap;
    }

    .pill{
      background: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 16px;
      white-space: nowrap;
    }

    .btn{
      border: 1px solid #c7c7c7;
      background: #fff;
      border-radius: 12px;
      padding: 10px 14px;
      font-size: 16px;
      cursor: pointer;
      white-space: nowrap;
    }
    .btn:active{ transform: translateY(1px); }

    /* Chat card */
    .chat-card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
    }

    #chat{
      height: 60vh;
      min-height: 360px;
      max-height: 520px;
      overflow-y: auto;
      padding: 10px 8px;
      border-radius: 12px;
    }

    .row{
      display: flex;
      margin: 10px 0;
    }

    .row.user{ justify-content: flex-end; }
    .row.bot{ justify-content: flex-start; }

    .bubble{
      max-width: 82%;
      padding: 12px 14px;
      border-radius: 16px;
      line-height: 1.25;
      font-size: 18px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .row.user .bubble{
      background: var(--bubble-user);
      border-top-right-radius: 6px; /* cantinho estilo print */
    }

    .row.bot .bubble{
      background: var(--bubble-bot);
      border-top-left-radius: 6px;
    }

    /* Composer */
    .composer{
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 14px;
    }

    #input{
      flex: 1;
      border: 3px solid #111; /* borda preta forte como no print */
      border-radius: 12px;
      padding: 14px 14px;
      font-size: 18px;
      outline: none;
      background: #fff;
    }

    .send{
      border: 1px solid #c7c7c7;
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px;
      font-size: 18px;
      cursor: pointer;
      min-width: 92px;
    }

    .hint{
      margin-top: 10px;
      font-size: 14px;
      color: var(--muted);
    }

    /* Mobile tweaks */
    @media (max-width: 520px){
      .title{ font-size: 34px; }
      .pill, .btn{ font-size: 15px; padding: 10px 12px; }
      .bubble{ font-size: 17px; }
      #input{ font-size: 17px; }
      .send{ font-size: 17px; min-width: 86px; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <h1 class="title">SDK Cognitivo</h1>
      <div class="right">
        <div id="session" class="pill">sessions: loading...</div>
        <button class="btn" onclick="resetSession()">Reset sess√£o</button>
      </div>
    </div>

    <div class="chat-card">
      <div id="chat"></div>
    </div>

    <div class="composer">
      <input id="input" placeholder="Digite sua mensagem..." autocomplete="off" />
      <button class="send" onclick="send()">Enviar</button>
    </div>

    <div class="hint">Dica: n√£o precisa atualizar a p√°gina. O cookie mant√©m sua sess√£o.</div>
  </div>

  <script>
    // ===== SESSION FIXA =====
    let sessionId = localStorage.getItem("session_id");
    if (!sessionId) {
      sessionId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random());
      localStorage.setItem("session_id", sessionId);
    }

    function addMessage(text, who) {
      const chat = document.getElementById("chat");
      const row = document.createElement("div");
      row.className = "row " + who;

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;

      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    async function refreshStatus() {
      try {
        const res = await fetch("/status", {
          headers: { "X-Session-Id": sessionId }
        });
        const data = await res.json();

        // Tenta mostrar algo no formato do print: "sessions: 1"
        // Se o backend mandar sessions_count, usamos. Sen√£o, mostramos o sessionId curto.
        const count =
          data.sessions ??
          data.session_count ??
          data.sessions_count ??
          data.count ??
          null;

        if (count !== null && count !== undefined) {
          document.getElementById("session").innerText = "sessions: " + count;
        } else {
          // fallback: mostrar 1 (j√° que existe uma sess√£o) ou mostrar um peda√ßo do id
          document.getElementById("session").innerText = "sessions: 1";
        }
      } catch (e) {
        document.getElementById("session").innerText = "sessions: 1";
      }
    }

    async function send() {
      const input = document.getElementById("input");
      const msg = input.value.trim();
      if (!msg) return;

      addMessage(msg, "user");
      input.value = "";
      input.focus();

      try {
        const res = await fetch("/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Session-Id": sessionId
          },
          body: JSON.stringify({ message: msg })
        });

        const data = await res.json();
        addMessage(data.reply ?? "(sem resposta)", "bot");
        refreshStatus();
      } catch (e) {
        addMessage("Erro ao conectar no servidor.", "bot");
      }
    }

    async function resetSession() {
      addMessage("üîÑ Resetando sess√£o...", "bot");

      try {
        // Se seu backend tiver /reset, √≥timo. Se n√£o tiver, ainda d√° feedback visual.
        const res = await fetch("/reset", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-Session-Id": sessionId
          }
        });

        let txt = "‚úÖ Reset: ";
        try {
          const data = await res.json();
          txt += JSON.stringify(data);
        } catch {
          txt += "ok";
        }

        addMessage(txt, "bot");
        refreshStatus();
      } catch (e) {
        addMessage("‚úÖ Reset solicitado (se o backend suportar /reset).", "bot");
        refreshStatus();
      }
    }

    // Enter para enviar
    document.getElementById("input").addEventListener("keydown", (e) => {
      if (e.key === "Enter") send();
    });

    // inicial
    refreshStatus();
  </script>
</body>
</html>
